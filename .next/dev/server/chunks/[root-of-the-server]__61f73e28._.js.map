{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 130, "column": 0}, "map": {"version":3,"sources":["file:///Users/pedro/Documents/gonzalezSoro_automatizacion/app/api/busca_id.js"],"sourcesContent":["import { google } from \"googleapis\";\n\nexport async function obtenerSpreadsheetId(nombreDepartamento) {\n  const auth = new google.auth.GoogleAuth({\n    credentials: JSON.parse(process.env.GOOGLE_CREDENTIALS),\n    scopes: [\n      \"https://www.googleapis.com/auth/drive\",\n      \"https://www.googleapis.com/auth/spreadsheets\"\n    ]\n  });\n\n  const drive = google.drive({ version: \"v3\", auth });\n\n  const res = await drive.files.list({\n    q: `\n      mimeType='application/vnd.google-apps.spreadsheet'\n      and name='${nombreDepartamento}'\n      and trashed=false\n    `,\n    fields: \"files(id, name)\",\n  });\n\n  if (res.data.files.length === 0) {\n    throw new Error(\"No se encontr√≥ el spreadsheet del departamento\");\n  }\n\n  return res.data.files[0].id;\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,qBAAqB,kBAAkB;IAC3D,MAAM,OAAO,IAAI,+JAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACtC,aAAa,KAAK,KAAK,CAAC,QAAQ,GAAG,CAAC,kBAAkB;QACtD,QAAQ;YACN;YACA;SACD;IACH;IAEA,MAAM,QAAQ,+JAAM,CAAC,KAAK,CAAC;QAAE,SAAS;QAAM;IAAK;IAEjD,MAAM,MAAM,MAAM,MAAM,KAAK,CAAC,IAAI,CAAC;QACjC,GAAG,CAAC;;gBAEQ,EAAE,mBAAmB;;IAEjC,CAAC;QACD,QAAQ;IACV;IAEA,IAAI,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,KAAK,GAAG;QAC/B,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAI,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,EAAE;AAC7B"}},
    {"offset": {"line": 165, "column": 0}, "map": {"version":3,"sources":["file:///Users/pedro/Documents/gonzalezSoro_automatizacion/app/api/impuestos/route.js"],"sourcesContent":["import { google } from \"googleapis\";\nimport { obtenerSpreadsheetId } from \"../busca_id\";\nimport { Readable } from \"stream\";\n\nconst ROOT_FOLDER_ID = \"1Sa9TRwwCzVv2bqS21AQV79yBavsyPJ-s\";\n\nconst COLUMNAS = {\n    EDESUR: \"B\",\n    AYSA: \"C\",\n    METROGAS: \"D\",\n    ABL: \"E\",\n    EXPENSAS: \"F\",\n    TELECOM: \"G\",\n    YSAUC: \"H\",\n    ABLUC: \"I\",\n    MUNICIPAL: \"J\",\n    ARBA: \"K\",\n};\n\nconst MESES = [\n    \"Enero\",\n    \"Febrero\",\n    \"Marzo\",\n    \"Abril\",\n    \"Mayo\",\n    \"Junio\",\n    \"Julio\",\n    \"Agosto\",\n    \"Septiembre\",\n    \"Octubre\",\n    \"Noviembre\",\n    \"Diciembre\",\n];\n\nconst FILA_INICIAL_POR_ANIO = {\n    2025: 15,\n    2026: 30,\n    2027: 45,\n    2028: 60,\n    2029: 75,\n    2030: 90,\n};\n\nfunction obtenerAnioDelImpuesto(mesSeleccionado) {\n    const ahora = new Date();\n    const anioActual = ahora.getFullYear();\n    const mesActual = ahora.getMonth(); // 0 = enero\n\n    const meses = [\n        \"Enero\", \"Febrero\", \"Marzo\", \"Abril\", \"Mayo\", \"Junio\",\n        \"Julio\", \"Agosto\", \"Septiembre\", \"Octubre\", \"Noviembre\", \"Diciembre\"\n    ];\n\n    const indiceMes = meses.indexOf(mesSeleccionado);\n    if (indiceMes === -1) return null;\n\n    // üëá regla real\n    return indiceMes > mesActual\n        ? anioActual - 1\n        : anioActual;\n}\n\nfunction obtenerFila(anio, mes) {\n    const filaBase = FILA_INICIAL_POR_ANIO[anio];\n    if (!filaBase) return null;\n\n    const indiceMes = MESES.indexOf(mes);\n    if (indiceMes === -1) return null;\n\n    return filaBase + indiceMes;\n}\n\nasync function obtenerOCrearCarpeta(drive, nombre, parentId) {\n    const res = await drive.files.list({\n        q: `\n      name='${nombre}'\n      and mimeType='application/vnd.google-apps.folder'\n      and '${parentId}' in parents\n      and trashed=false\n    `,\n        fields: \"files(id, name)\",\n    });\n\n    if (res.data.files.length > 0) {\n        return res.data.files[0].id;\n    }\n\n    const folder = await drive.files.create({\n        requestBody: {\n            name: nombre,\n            mimeType: \"application/vnd.google-apps.folder\",\n            parents: [parentId],\n        },\n    });\n\n    return folder.data.id;\n}\n\n\nexport async function POST(req) {\n    try {\n        const formData = await req.formData();\n\n        const departamento = formData.get(\"departamento\");\n        const impuesto = formData.get(\"impuesto\");\n        const mes = formData.get(\"mes\");\n        const importe = Number(formData.get(\"importe\"));\n        const comprobante = formData.get(\"comprobante\"); // File | null\n\n        const spreadsheetId = await obtenerSpreadsheetId(departamento);\n        const columna = COLUMNAS[impuesto];\n\n        const anioImpuesto = obtenerAnioDelImpuesto(mes);\n        const fila = obtenerFila(anioImpuesto, mes);\n\n        if (!spreadsheetId || !columna || !fila) {\n            return Response.json(\n                { error: \"Datos inv√°lidos\", debug: { spreadsheetId, columna, anioImpuesto, fila } },\n                { status: 400 }\n            );\n        }\n\n        const celda = `'RESUMEN'!${columna}${fila}`;\n\n        const auth = new google.auth.OAuth2(\n            process.env.GOOGLE_CLIENT_ID,\n            process.env.GOOGLE_CLIENT_SECRET\n        );\n\n        auth.setCredentials({\n            refresh_token: process.env.GOOGLE_REFRESH_TOKEN,\n        });\n\n        const drive = google.drive({ version: \"v3\", auth });\n        const sheets = google.sheets({ version: \"v4\", auth });\n\n        const departamentoFolderId = await obtenerOCrearCarpeta(\n            drive,\n            departamento,\n            ROOT_FOLDER_ID\n        );\n\n        const impuestoFolderId = await obtenerOCrearCarpeta(\n            drive,\n            impuesto,\n            departamentoFolderId\n        );\n\n        const folderId = impuestoFolderId;\n\n        if (comprobante) {\n            const buffer = Buffer.from(await comprobante.arrayBuffer());\n            const stream = Readable.from(buffer);\n\n            await drive.files.create({\n                requestBody: {\n                    name: `${mes} - ${impuesto}.${comprobante.name.split(\".\").pop()}`,\n                    parents: [folderId],\n                },\n                media: {\n                    mimeType: comprobante.type,\n                    body: stream,\n                },\n            });\n\n        }\n\n        await sheets.spreadsheets.values.update({\n            spreadsheetId,\n            range: celda,\n            valueInputOption: \"USER_ENTERED\",\n            requestBody: {\n                values: [[importe]],\n            },\n        });\n\n        return Response.json({ ok: true, celda });\n    } catch (err) {\n        console.error(err);\n        return Response.json(\n            { error: \"Error interno\", details: err.message },\n            { status: 500 }\n        );\n    }\n}\n\n"],"names":[],"mappings":"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"}}]
}