{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 130, "column": 0}, "map": {"version":3,"sources":["file:///Users/pedro/Documents/gonzalezSoro_automatizacion/app/api/busca_id.js"],"sourcesContent":["import { google } from \"googleapis\";\n\nexport async function obtenerSpreadsheetId(nombreDepartamento) {\n  const auth = new google.auth.GoogleAuth({\n    credentials: JSON.parse(process.env.GOOGLE_CREDENTIALS),\n    scopes: [\n      \"https://www.googleapis.com/auth/drive\",\n      \"https://www.googleapis.com/auth/spreadsheets\"\n    ]\n  });\n\n  const drive = google.drive({ version: \"v3\", auth });\n\n  const res = await drive.files.list({\n    q: `\n      mimeType='application/vnd.google-apps.spreadsheet'\n      and name='${nombreDepartamento}'\n      and trashed=false\n    `,\n    fields: \"files(id, name)\",\n  });\n\n  if (res.data.files.length === 0) {\n    throw new Error(\"No se encontró el spreadsheet del departamento\");\n  }\n\n  return res.data.files[0].id;\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,qBAAqB,kBAAkB;IAC3D,MAAM,OAAO,IAAI,+JAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACtC,aAAa,KAAK,KAAK,CAAC,QAAQ,GAAG,CAAC,kBAAkB;QACtD,QAAQ;YACN;YACA;SACD;IACH;IAEA,MAAM,QAAQ,+JAAM,CAAC,KAAK,CAAC;QAAE,SAAS;QAAM;IAAK;IAEjD,MAAM,MAAM,MAAM,MAAM,KAAK,CAAC,IAAI,CAAC;QACjC,GAAG,CAAC;;gBAEQ,EAAE,mBAAmB;;IAEjC,CAAC;QACD,QAAQ;IACV;IAEA,IAAI,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,KAAK,GAAG;QAC/B,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAI,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,EAAE;AAC7B"}},
    {"offset": {"line": 165, "column": 0}, "map": {"version":3,"sources":["file:///Users/pedro/Documents/gonzalezSoro_automatizacion/app/api/crear-maestro/route.js"],"sourcesContent":["import { google } from \"googleapis\";\nimport { obtenerSpreadsheetId } from \"../busca_id\";\n\nconst DEPARTAMENTOS = [\n  \"Acevedo\",\n  \"Alsina 1138\",\n  \"Alsina 1905\",\n  \"Aráoz\",\n  \"Artigas\",\n  \"Austria\",\n  \"Av la Plata\",\n  \"Avellaneda\",\n  \"Ayacucho 1085\",\n  \"Ayacucho 331\",\n  \"Bernardo de Irigoyen\",\n  \"Beruti\",\n  \"Billinghurst\",\n  \"Bulnes\",\n  \"Cervantes\",\n  \"Charcas\",\n  \"Cramer\",\n  \"Don Bosco\",\n  \"El Potrero\",\n  \"Esmeralda 3 K\",\n  \"Esmeralda 5 A\",\n  \"Esmeralda 5 D\",\n  \"Eva Perón\",\n  \"Formosa 129\",\n  \"Formosa 380\",\n  \"G Lorca cochera 340\",\n  \"G Lorca cochera 97\",\n  \"G Lorca piso 22\",\n  \"G Lorca piso 3\",\n  \"H Irigoyen\",\n  \"Independencia\",\n  \"La Rioja\",\n  \"Lacarra\",\n  \"Lapida 1898\",\n  \"Las Heras\",\n  \"Lavalle\",\n  \"Lavalleja\",\n  \"Libertad 844\",\n  \"Libertad 960\",\n  \"M T de Alvear\",\n  \"Mar de las Pampas\",\n  \"Mario Bravo 5 A\",\n  \"Matheu 1 A\",\n  \"Matheu 2 G\",\n  \"Matheu 4 E\",\n  \"Ortega y Gasset\",\n  \"Paraguay 754\",\n  \"Paraguay 783\",\n  \"Pilar dormi\",\n  \"Pueyrredon 1655\",\n  \"Pueyrredon 1978\",\n  \"Quimo Costa\",\n  \"R Pena 10 C\",\n  \"R Pena 10 D\",\n  \"R Pena 2 B\",\n  \"R Pena 2 C\",\n  \"R Pena 2 D\",\n  \"R Pena 3 D\",\n  \"R Pena 4 C\",\n  \"R Pena 4 D\",\n  \"Ravignani\",\n  \"Rawson\",\n  \"Riobamba\",\n  \"Rivadavia 1525\",\n  \"Rivadavia 1611\",\n  \"Rivadavia 4085\",\n  \"Rivadavia 822\",\n  \"Saavedra 2\",\n  \"Saavedra PB\",\n  \"San Benito\",\n  \"San Juan\",\n  \"Santa Fe 2545\",\n  \"Siria 5 A\",\n  \"Siria 7 27\",\n  \"Talcahuano 1242\",\n  \"Uruguay 14 D\",\n  \"Uruguay 7 B\",\n  \"Valle\",\n  \"Vidt 2052\",\n  \"Vidt 2137\",\n  \"Yapeyú\",\n  \"Yatay\",\n];\n\nconst IMPUESTOS = [\n  \"ABL\",\n  \"ABLUC\",\n  \"ARBA\",\n  \"AYSA\",\n  \"AYSAUC\",\n  \"EDESUR\",\n  \"EXPENSAS\",\n  \"METROGAS\",\n  \"MUNICIPAL\",\n  \"TELECOM\",\n];\n\nconst COLUMNAS = {\n  EDESUR: \"B\",\n  AYSA: \"C\",\n  METROGAS: \"D\",\n  ABL: \"E\",\n  EXPENSAS: \"F\",\n  TELECOM: \"G\",\n  AYSAUC: \"H\",\n  ABLUC: \"I\",\n  MUNICIPAL: \"J\",\n  ARBA: \"K\",\n};\n\nconst MESES = [\n  \"Enero\",\n  \"Febrero\",\n  \"Marzo\",\n  \"Abril\",\n  \"Mayo\",\n  \"Junio\",\n  \"Julio\",\n  \"Agosto\",\n  \"Septiembre\",\n  \"Octubre\",\n  \"Noviembre\",\n  \"Diciembre\",\n];\n\nconst FILA_INICIAL_POR_ANIO = {\n  2025: 15,\n  2026: 30,\n  2027: 45,\n  2028: 60,\n  2029: 75,\n  2030: 90,\n};\n\nfunction obtenerAnioDelImpuesto(mesSeleccionado) {\n  const ahora = new Date();\n  const anioActual = ahora.getFullYear();\n  const mesActual = ahora.getMonth();\n  const indiceMes = MESES.indexOf(mesSeleccionado);\n  if (indiceMes === -1) return null;\n  return indiceMes > mesActual ? anioActual - 1 : anioActual;\n}\n\nfunction obtenerFila(anio, mes) {\n  const filaBase = FILA_INICIAL_POR_ANIO[anio];\n  if (!filaBase) return null;\n  const indiceMes = MESES.indexOf(mes);\n  if (indiceMes === -1) return null;\n  return filaBase + indiceMes;\n}\n\nasync function leerValoresDepartamento(sheets, departamento, mes) {\n  try {\n    const spreadsheetId = await obtenerSpreadsheetId(departamento);\n    const anioImpuesto = obtenerAnioDelImpuesto(mes);\n    const fila = obtenerFila(anioImpuesto, mes);\n    if (!spreadsheetId || !fila) return null;\n\n    const range = `'RESUMEN'!A${fila}:K${fila}`;\n    const response = await sheets.spreadsheets.values.get({\n      spreadsheetId,\n      range,\n    });\n\n    return response.data.values?.[0] || [];\n  } catch (err) {\n    // Si falla (no existe el depto o no tiene datos), devolvemos null para esa fila\n    return null;\n  }\n}\n\nexport async function POST(req) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const nombre = searchParams.get(\"nombre\") || `Maestro departamentos ${new Date().toISOString().slice(0, 10)}`;\n\n    const auth = new google.auth.OAuth2(\n      process.env.GOOGLE_CLIENT_ID,\n      process.env.GOOGLE_CLIENT_SECRET\n    );\n\n    auth.setCredentials({\n      refresh_token: process.env.GOOGLE_REFRESH_TOKEN,\n    });\n\n    const sheets = google.sheets({ version: \"v4\", auth });\n\n    // 1) Crear el spreadsheet maestro\n    const createRes = await sheets.spreadsheets.create({\n      requestBody: {\n        properties: { title: nombre },\n      },\n    });\n\n    const spreadsheetId = createRes.data.spreadsheetId;\n    const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;\n    const baseSheetId = createRes.data.sheets?.[0]?.properties?.sheetId;\n\n    // 2) Renombrar la hoja inicial a \"Enero\" y crear el resto de los meses\n    const batchRequests = [];\n    if (baseSheetId !== undefined) {\n      batchRequests.push({\n        updateSheetProperties: {\n          properties: { sheetId: baseSheetId, title: \"Enero\" },\n          fields: \"title\",\n        },\n      });\n    }\n\n    for (let i = 1; i < MESES.length; i++) {\n      batchRequests.push({\n        addSheet: {\n          properties: {\n            title: MESES[i],\n          },\n        },\n      });\n    }\n\n    if (batchRequests.length > 0) {\n      await sheets.spreadsheets.batchUpdate({\n        spreadsheetId,\n        requestBody: { requests: batchRequests },\n      });\n    }\n\n    // 3) Para cada mes, llenar tabla: fila 1 = encabezado, columna A = impuestos\n    for (const mes of MESES) {\n      const header = [\"Impuesto\", ...DEPARTAMENTOS];\n      const rows = IMPUESTOS.map((imp) => [imp]);\n\n      for (const departamento of DEPARTAMENTOS) {\n        const valores = await leerValoresDepartamento(sheets, departamento, mes);\n        for (let i = 0; i < IMPUESTOS.length; i++) {\n          const impuesto = IMPUESTOS[i];\n          const columna = COLUMNAS[impuesto];\n          const idx = columna.charCodeAt(0) - 65; // A->0\n          const valor = valores && valores[idx] !== undefined ? valores[idx] : \"\";\n          rows[i].push(valor === undefined ? \"\" : valor);\n        }\n      }\n\n      const values = [header, ...rows];\n      await sheets.spreadsheets.values.update({\n        spreadsheetId,\n        range: `${mes}!A1`,\n        valueInputOption: \"USER_ENTERED\",\n        requestBody: { values },\n      });\n    }\n\n    return Response.json({\n      ok: true,\n      spreadsheetId,\n      spreadsheetUrl,\n      hojas: MESES.length,\n      columnas: DEPARTAMENTOS.length + 1,\n      filasPorHoja: IMPUESTOS.length + 1,\n    });\n  } catch (err) {\n    console.error(\"Error creando maestro:\", err);\n    return Response.json({ error: \"No se pudo crear el maestro\", details: err.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,gBAAgB;IACpB;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAED,MAAM,YAAY;IAChB;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAED,MAAM,WAAW;IACf,QAAQ;IACR,MAAM;IACN,UAAU;IACV,KAAK;IACL,UAAU;IACV,SAAS;IACT,QAAQ;IACR,OAAO;IACP,WAAW;IACX,MAAM;AACR;AAEA,MAAM,QAAQ;IACZ;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAED,MAAM,wBAAwB;IAC5B,MAAM;IACN,MAAM;IACN,MAAM;IACN,MAAM;IACN,MAAM;IACN,MAAM;AACR;AAEA,SAAS,uBAAuB,eAAe;IAC7C,MAAM,QAAQ,IAAI;IAClB,MAAM,aAAa,MAAM,WAAW;IACpC,MAAM,YAAY,MAAM,QAAQ;IAChC,MAAM,YAAY,MAAM,OAAO,CAAC;IAChC,IAAI,cAAc,CAAC,GAAG,OAAO;IAC7B,OAAO,YAAY,YAAY,aAAa,IAAI;AAClD;AAEA,SAAS,YAAY,IAAI,EAAE,GAAG;IAC5B,MAAM,WAAW,qBAAqB,CAAC,KAAK;IAC5C,IAAI,CAAC,UAAU,OAAO;IACtB,MAAM,YAAY,MAAM,OAAO,CAAC;IAChC,IAAI,cAAc,CAAC,GAAG,OAAO;IAC7B,OAAO,WAAW;AACpB;AAEA,eAAe,wBAAwB,MAAM,EAAE,YAA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"}}]
}