{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 130, "column": 0}, "map": {"version":3,"sources":["file:///Users/pedro/Documents/gonzalezSoro_automatizacion/app/api/busca_id.js"],"sourcesContent":["import { google } from \"googleapis\";\n\nexport async function obtenerSpreadsheetId(nombreDepartamento) {\n  const auth = new google.auth.GoogleAuth({\n    credentials: JSON.parse(process.env.GOOGLE_CREDENTIALS),\n    scopes: [\n      \"https://www.googleapis.com/auth/drive\",\n      \"https://www.googleapis.com/auth/spreadsheets\"\n    ]\n  });\n\n  const drive = google.drive({ version: \"v3\", auth });\n\n  const res = await drive.files.list({\n    q: `\n      mimeType='application/vnd.google-apps.spreadsheet'\n      and name='${nombreDepartamento}'\n      and trashed=false\n    `,\n    fields: \"files(id, name)\",\n  });\n\n  if (res.data.files.length === 0) {\n    throw new Error(\"No se encontrÃ³ el spreadsheet del departamento\");\n  }\n\n  return res.data.files[0].id;\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,qBAAqB,kBAAkB;IAC3D,MAAM,OAAO,IAAI,+JAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACtC,aAAa,KAAK,KAAK,CAAC,QAAQ,GAAG,CAAC,kBAAkB;QACtD,QAAQ;YACN;YACA;SACD;IACH;IAEA,MAAM,QAAQ,+JAAM,CAAC,KAAK,CAAC;QAAE,SAAS;QAAM;IAAK;IAEjD,MAAM,MAAM,MAAM,MAAM,KAAK,CAAC,IAAI,CAAC;QACjC,GAAG,CAAC;;gBAEQ,EAAE,mBAAmB;;IAEjC,CAAC;QACD,QAAQ;IACV;IAEA,IAAI,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,KAAK,GAAG;QAC/B,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAI,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,EAAE;AAC7B"}},
    {"offset": {"line": 189, "column": 0}, "map": {"version":3,"sources":["file:///Users/pedro/Documents/gonzalezSoro_automatizacion/app/api/lib/mailer.js"],"sourcesContent":["import nodemailer from \"nodemailer\";\n\nexport const transporter = nodemailer.createTransport({\n  service: \"gmail\",\n  auth: {\n    user: process.env.MAIL_USER,\n    pass: process.env.MAIL_PASS,\n  },\n});\n\nexport async function enviarMail({ to, subject, html }) {\n  return transporter.sendMail({\n    from: `\"Impuestos Bot ðŸ¤–\" <${process.env.MAIL_USER}>`,\n    to,\n    subject,\n    html,\n  });\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,cAAc,4JAAU,CAAC,eAAe,CAAC;IACpD,SAAS;IACT,MAAM;QACJ,MAAM,QAAQ,GAAG,CAAC,SAAS;QAC3B,MAAM,QAAQ,GAAG,CAAC,SAAS;IAC7B;AACF;AAEO,eAAe,WAAW,EAAE,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE;IACpD,OAAO,YAAY,QAAQ,CAAC;QAC1B,MAAM,CAAC,oBAAoB,EAAE,QAAQ,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC;QACrD;QACA;QACA;IACF;AACF"}},
    {"offset": {"line": 216, "column": 0}, "map": {"version":3,"sources":["file:///Users/pedro/Documents/gonzalezSoro_automatizacion/app/api/impuestos/route.js"],"sourcesContent":["import { google } from \"googleapis\";\nimport { obtenerSpreadsheetId } from \"../busca_id\";\nimport { Readable } from \"stream\";\nimport { enviarMail } from \"../lib/mailer\";\n\nconst ROOT_FOLDER_ID = \"1Sa9TRwwCzVv2bqS21AQV79yBavsyPJ-s\";\n\nconst MESES = [\n    \"Enero\",\n    \"Febrero\",\n    \"Marzo\",\n    \"Abril\",\n    \"Mayo\",\n    \"Junio\",\n    \"Julio\",\n    \"Agosto\",\n    \"Septiembre\",\n    \"Octubre\",\n    \"Noviembre\",\n    \"Diciembre\",\n];\n\nexport const maxDuration = 60;\n\n// cada aÃ±o ocupa 15 filas\nconst FILA_INICIAL_POR_ANIO = {\n    2025: 5,\n    2026: 20,\n    2027: 35,\n    2028: 50,\n    2029: 65,\n    2030: 80,\n};\n\nfunction obtenerAnioDelImpuesto(mesSeleccionado) {\n    const ahora = new Date();\n    const anioActual = ahora.getFullYear();\n    const mesActual = ahora.getMonth(); // 0 = enero\n\n    const indiceMes = MESES.indexOf(mesSeleccionado);\n    if (indiceMes === -1) return null;\n\n    return indiceMes > mesActual ? anioActual - 1 : anioActual;\n}\n\nfunction obtenerFila(anio, mes) {\n    const filaBase = FILA_INICIAL_POR_ANIO[anio];\n    if (!filaBase) return null;\n\n    const indiceMes = MESES.indexOf(mes);\n    if (indiceMes === -1) return null;\n\n    return filaBase + indiceMes;\n}\n\nasync function obtenerOCrearCarpeta(drive, nombre, parentId) {\n    const res = await drive.files.list({\n        q: `\n      name='${nombre}'\n      and mimeType='application/vnd.google-apps.folder'\n      and '${parentId}' in parents\n      and trashed=false\n    `,\n        fields: \"files(id, name)\",\n    });\n\n    if (res.data.files.length > 0) {\n        return res.data.files[0].id;\n    }\n\n    const folder = await drive.files.create({\n        requestBody: {\n            name: nombre,\n            mimeType: \"application/vnd.google-apps.folder\",\n            parents: [parentId],\n        },\n    });\n\n    return folder.data.id;\n}\n\nexport async function POST(req) {\n    try {\n        const formData = await req.formData();\n\n        const departamento = formData.get(\"departamento\");\n        const impuesto = formData.get(\"impuesto\"); // nombre de la hoja\n        const mes = formData.get(\"mes\");\n        const importeRaw = formData.get(\"importe\");\n        const importe = parseFloat(importeRaw.replace(',', '.'));\n        const comprobante = formData.get(\"comprobante\");\n\n        const spreadsheetId = await obtenerSpreadsheetId(departamento);\n\n        const anioImpuesto = obtenerAnioDelImpuesto(mes);\n        const fila = obtenerFila(anioImpuesto, mes);\n\n        if (!spreadsheetId || !impuesto || !fila) {\n            return Response.json(\n                { error: \"Datos invÃ¡lidos\", debug: { spreadsheetId, impuesto, anioImpuesto, fila } },\n                { status: 400 }\n            );\n        }\n\n        // ðŸ‘‰ escribimos en la hoja del impuesto\n        const rango = `'${impuesto}'C${fila}`;\n\n        const auth = new google.auth.OAuth2(\n            process.env.GOOGLE_CLIENT_ID,\n            process.env.GOOGLE_CLIENT_SECRET\n        );\n\n        auth.setCredentials({\n            refresh_token: process.env.GOOGLE_REFRESH_TOKEN,\n        });\n\n        const drive = google.drive({ version: \"v3\", auth });\n        const sheets = google.sheets({ version: \"v4\", auth });\n\n        const departamentoFolderId = await obtenerOCrearCarpeta(\n            drive,\n            departamento,\n            ROOT_FOLDER_ID\n        );\n\n        const impuestoFolderId = await obtenerOCrearCarpeta(\n            drive,\n            impuesto,\n            departamentoFolderId\n        );\n\n        const carpetaUrl = `https://drive.google.com/drive/folders/${impuestoFolderId}`;\n\n        if (comprobante) {\n            const buffer = Buffer.from(await comprobante.arrayBuffer());\n            const stream = Readable.from(buffer);\n\n            await drive.files.create({\n                requestBody: {\n                    name: `${mes} - ${impuesto}.${comprobante.name.split(\".\").pop()}`,\n                    parents: [impuestoFolderId],\n                },\n                media: {\n                    mimeType: comprobante.type,\n                    body: stream,\n                },\n            });\n        }\n\n        await sheets.spreadsheets.values.update({\n            spreadsheetId,\n            range: `'${impuesto}'!C${fila}`,\n            valueInputOption: \"USER_ENTERED\",\n            requestBody: {\n                values: [[importe]],\n            },\n        });\n\n        await enviarMail({\n            to: \"mvcalvar@gmail.com\",\n            subject: `ðŸ“Ž Comprobante cargado â€“ ${departamento} / ${impuesto}`,\n            html: `\n                <h2>Nuevo comprobante cargado</h2>\n                <p><strong>Departamento:</strong> ${departamento}</p>\n                <p><strong>Impuesto:</strong> ${impuesto}</p>\n                <p><strong>Mes:</strong> ${mes}</p>\n                <p><strong>Monto:</strong> $${importe}</p>\n\n                <p>\n                ðŸ‘‰ <a href=\"${carpetaUrl}\" target=\"_blank\">\n                    Ver carpeta del impuesto en Drive\n                </a>\n                </p>\n            `,\n        });\n\n        return Response.json({ ok: true, rango });\n    } catch (err) {\n        console.error(err);\n        return Response.json(\n            { error: \"Error interno\", details: err.message },\n            { status: 500 }\n        );\n    }\n}\n"],"names":[],"mappings":"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"}}]
}